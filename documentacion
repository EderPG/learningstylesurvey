# Documentaci√≥n T√©cnica Completa - Plugin Learning Style Survey para Moodle

---

## 1. Introducci√≥n

El plugin **Learning Style Survey** permite adaptar rutas de aprendizaje en Moodle seg√∫n el estilo detectado de cada estudiante. Es modular, extensible y pensado para facilitar la integraci√≥n y expansi√≥n por parte de desarrolladores. El objetivo es potenciar el aprendizaje personalizado, mejorar la experiencia educativa y permitir la personalizaci√≥n y gesti√≥n avanzada por parte de docentes.

---

## 2. Arquitectura General

### Componentes principales

- **Encuesta de estilos de aprendizaje:** Detecta el perfil del usuario mediante preguntas y algoritmos de clasificaci√≥n.
- **Gestor de rutas de aprendizaje:** Asigna y administra rutas adaptativas, pasos, recursos y evaluaciones por curso.
- **Gesti√≥n y visualizaci√≥n del progreso:** Muestra el avance del usuario, bloquea/permite avanzar seg√∫n resultados y registra el progreso.
- **Gesti√≥n docente:** Permite a los profesores crear, editar y organizar rutas, pasos, recursos y evaluaciones, as√≠ como consultar el avance de los estudiantes.
- **Recuperaci√≥n y retroalimentaci√≥n:** Si el estudiante reprueba una evaluaci√≥n, se le asignan recursos de recuperaci√≥n o repite el paso.

#### Diagrama de flujo textual

```text
Estudiante completa encuesta ‚Üí Sistema detecta estilo ‚Üí Asigna ruta personalizada ‚Üí 
Visualiza pasos ‚Üí Realiza recursos/evaluaciones ‚Üí Avanza si aprueba ‚Üí Progreso registrado.
Docente configura rutas/pasos/recursos ‚Üí Consulta el avance de sus alumnos.
```

---

## 3. Estructura de Archivos y Funcionalidad

| Archivo/Fichero         | Descripci√≥n T√©cnica ----------                                                                                                                               |
|-------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| `mod_form.php`          | Formulario de configuraci√≥n del m√≥dulo en Moodle. Permite agregar nombre, descripci√≥n y par√°metros est√°ndar.                                      |
| `vista_estudiante.php`  | Interfaz principal del estudiante. Obtiene el estilo del usuario, muestra la ruta, los pasos y el progreso. Gestiona avance y validaci√≥n de pasos.|
| `learningpath.php`      | Interfaz para el docente. Visualiza rutas existentes, permite editar/crear rutas y modificar el orden de los pasos.                               |
| `createsteproute.php`   | Formulario para crear nuevos pasos de una ruta, asociando recursos y evaluaciones. Procesa POST y guarda en BD.                                  |
| `edit_learningpath.php` | Permite editar una ruta existente, modificar pasos y reasignar recursos/evaluaciones. Resetea el progreso si se cambia la ruta.                  |
| `siguiente.php`         | L√≥gica de avance a siguiente paso. Verifica si el usuario puede avanzar, actualiza el progreso o marca la ruta como completada.                  |
| `responder_quiz.php`    | Renderiza el cuestionario/quiz adaptativo y permite registrar/calificar resultados. Gestiona recuperaci√≥n si el usuario reprueba.                |
| `verruta.php`           | Vista adicional para mostrar al estudiante los pasos y recursos asignados seg√∫n su estilo.                                                       |
| `results.php`           | Muestra resultados de encuestas y evaluaciones, √∫til para an√°lisis docente.                                                                      |
| `guardar_examen.php`    | Procesa y almacena los resultados de ex√°menes realizados por los estudiantes.                                                                    |
| `guardar_orden.php`     | Permite guardar el orden de los pasos en una ruta, √∫til para la personalizaci√≥n docente.                                                         |
| `guardar_paso_ruta.php` | Almacena la informaci√≥n de un nuevo paso en la ruta de aprendizaje.                                                                              |
| `organizar_ruta.php`    | Herramienta para organizar y reordenar los pasos de una ruta.                                                                                    |
| `uploadresource.php`    | Permite la subida de recursos did√°cticos (archivos, im√°genes, PDFs, etc.).                                                                      |
| `ver_recurso.php`       | Visualiza recursos asignados a un paso espec√≠fico.                                                                                               |
| `temas.php`             | Gesti√≥n de temas y categor√≠as de recursos, √∫til para la administraci√≥n docente.                                                                  |
| `crear_examen.php`      | Permite la creaci√≥n de ex√°menes y su asociaci√≥n a pasos de rutas.                                                                                |
| `lib.php / locallib.php`| Funciones auxiliares y l√≥gica de negocio reutilizable en el plugin.                                                                              |
| `version.php`           | Define la versi√≥n del plugin y dependencias requeridas por Moodle.                                                                               |
| `README.md`             | Informaci√≥n b√°sica, instalaci√≥n y uso r√°pido del plugin.                                                                                         |
| Carpeta `db`            | Archivos de definici√≥n de tablas, accesos y actualizaciones de la base de datos.                                                                |
| Carpeta `lang`          | Archivos de idioma para internacionalizaci√≥n.                                                                                                    |
| Carpeta `pix`           | Im√°genes e √≠conos utilizados en la interfaz.                                                                                                     |
| Carpeta `uploads`       | Archivos subidos por los usuarios (recursos, im√°genes, PDFs, etc.).                                                                             |

---

## 4. Modelo de Datos y Tablas

### Principales tablas

- **learningstylesurvey_userstyles:** Guarda el estilo detectado para cada usuario.
- **learningstylesurvey_paths:** Define rutas de aprendizaje por curso.
- **learningpath_steps:** Pasos de cada ruta, con recursos y evaluaciones asociadas.
- **learningstylesurvey_user_progress:** Registra el progreso de cada usuario en su ruta.
- **learningstylesurvey_resources:** Recursos did√°cticos.
- **learningstylesurvey_quizzes:** Evaluaciones asociadas.

#### Relaciones principales

- Cada usuario tiene un estilo (`userstyles`).
- Cada ruta (`paths`) puede tener m√∫ltiples pasos (`steps`).
- Cada paso puede tener m√∫ltiples recursos y evaluaciones.
- El progreso del usuario se registra por ruta y paso.
- Los recursos y evaluaciones pueden estar asociados a temas y pasos espec√≠ficos.

---

## 5. Extensibilidad y Buenas Pr√°cticas

### Puntos de extensi√≥n recomendados

- **Nuevos tipos de estilos de aprendizaje:** Modificar la l√≥gica de la encuesta y el algoritmo de asignaci√≥n.
- **Nuevos recursos o actividades:** Agregar tablas y l√≥gica para asociar otros tipos de recursos (videos, foros, SCORM, etc.).
- **Integraci√≥n con otras APIs de Moodle:** Utilizar hooks y eventos de Moodle para expandir notificaciones, reportes, etc.
- **Mejoras en la gesti√≥n docente:** A√±adir dashboards, reportes avanzados, personalizaci√≥n de rutas por grupo, etc.
- **Internacionalizaci√≥n:** Agregar nuevos idiomas en la carpeta `lang`.
- **Seguridad y permisos:** Revisar y mejorar el uso de `require_capability()` y roles.

### Recomendaciones de desarrollo

- Mantener compatibilidad con las APIs est√°ndar de Moodle.
- Utilizar funciones de acceso a datos de Moodle para evitar SQL directos.
- Separar la l√≥gica de negocio de la presentaci√≥n (MVC b√°sico).
- Documentar cada funci√≥n y archivo nuevo.
- Realizar pruebas unitarias y de integraci√≥n.
- Usar control de versiones (Git) y ramas para desarrollo colaborativo.
- Seguir las gu√≠as de estilo de c√≥digo de Moodle.

---

## 6. Ejemplo de Expansi√≥n: Agregar un Nuevo Tipo de Recurso

1. Crear nueva tabla `learningstylesurvey_videos` con campos relevantes.
2. Modificar `createsteproute.php` y `edit_learningpath.php` para permitir seleccionar y asociar videos a pasos.
3. Actualizar la l√≥gica en `vista_estudiante.php` para renderizar videos seg√∫n el paso.
4. Documentar el nuevo componente y agregar test unitarios.
5. A√±adir soporte en la interfaz docente para gestionar videos.

---

## 7. Integraci√≥n con Moodle

- **Hooks y APIs:** Uso de funciones est√°ndar como `require_login()`, `context_course::instance()`, `$DB->get_record()`, `$OUTPUT->header()`, etc.
- **Formularios:** `mod_form.php` utiliza la clase `moodleform_mod`.
- **Contextos y permisos:** Uso de `require_capability()` para validar roles y permisos.
- **Internacionalizaci√≥n:** Archivos en `lang` para traducci√≥n de la interfaz.
- **Gesti√≥n de archivos:** Recursos subidos se almacenan en la carpeta `uploads`.

---

## 8. Ciclo de vida de usuario

### Estudiante

- Ingresa al curso, responde la encuesta.
- Se le asigna una ruta personalizada seg√∫n su estilo.
- Avanza paso a paso (recursos, evaluaciones).
- Si reprueba, recibe recursos de recuperaci√≥n o repite el paso.
- Finaliza la ruta y puede consultar su progreso y resultados.
- Puede acceder a recursos adicionales seg√∫n su avance y estilo.

### Docente

- Configura rutas, pasos, recursos y evaluaciones.
- Consulta el avance de sus estudiantes.
- Modifica rutas y pasos seg√∫n necesidades.
- Accede a reportes y dashboards.
- Gestiona temas, recursos y ex√°menes.
- Organiza y personaliza la experiencia de aprendizaje adaptativo.

---

## 9. Troubleshooting y Preguntas Frecuentes

- **No se asigna ruta al estudiante:** Verificar que el usuario haya completado la encuesta y que existan rutas definidas para el curso.
- **No avanza al siguiente paso:** Revisar la configuraci√≥n de evaluaciones y los redirects (`passredirect`, `failredirect`).
- **Error al crear recurso/evaluaci√≥n:** Comprobar la estructura de las tablas y permisos del usuario.
- **Problemas de visualizaci√≥n:** Revisar los archivos en `pix` y la configuraci√≥n de recursos subidos.
- **Errores de permisos:** Validar el uso de `require_capability()` y los roles asignados en Moodle.

---

## 10. Anexos y Ejemplos

### Fragmento de avance de paso (vista_estudiante.php)

```php
if ($result->score >= 70 && $currentstep->passredirect) {
    $progress->current_stepid = $currentstep->passredirect;
    $DB->update_record('learningstylesurvey_user_progress', $progress);
    redirect(new moodle_url('/mod/learningstylesurvey/vista_estudiante.php', ['courseid'=>$courseid,'pathid'=>$pathid]));
}
```

### SQL ejemplo: Obtener pasos de una ruta

```sql
SELECT * FROM {learningpath_steps}
WHERE pathid = ?
ORDER BY stepnumber ASC;
```

### Ejemplo de definici√≥n de recurso en PHP

```php
$resource = [
    'id' => 1,
    'tema_id' => 2,
    'name' => 'Video Introductorio',
    'type' => 'video',
    'url' => 'https://...'
];
$DB->insert_record('learningstylesurvey_resources', $resource);
```

### Ejemplo de formulario en mod_form.php

```php
$mform->addElement('text', 'name', get_string('learningstylesurveyname', 'learningstylesurvey'), array('size' => '64'));
$mform->setType('name', PARAM_TEXT);
$mform->addRule('name', null, 'required', null, 'client');
$this->standard_intro_elements();
$this->standard_coursemodule_elements();
$this->add_action_buttons();
```

---

## 11. üîÑ Revisi√≥n de Portabilidad - Gu√≠a de Instalaci√≥n Multiplataforma

### ‚úÖ Problemas de Portabilidad Corregidos

#### 1. **Enlaces Hardcodeados a URLs Relativas**

**Problema**: Muchos archivos usaban enlaces directos como `href="view.php?id=123"` que fallar√≠an en otros entornos.

**Soluci√≥n**: Reemplazados por `moodle_url` est√°ndar:

```php
// ‚ùå Antes (hardcoded)
echo "<a href='view.php?id={$cmid}'>Regresar</a>";

// ‚úÖ Despu√©s (portable)
$viewurl = new moodle_url('/mod/learningstylesurvey/view.php', ['id' => $cmid]);
echo "<a href='" . $viewurl->out() . "'>Regresar</a>";
```

**Archivos Corregidos**:

- ‚úÖ `manage_quiz.php` - 2 enlaces corregidos
- ‚úÖ `uploadresource.php` - 1 enlace corregido  
- ‚úÖ `crear_examen.php` - 1 enlace corregido
- ‚úÖ `responder_quiz.php` - 1 enlace corregido
- ‚úÖ `view.php` - 1 enlace corregido
- ‚úÖ `verificar_funcionalidades.php` - 7 enlaces corregidos
- ‚úÖ `ver_recurso.php` - 1 enlace corregido

#### 2. **Obtenci√≥n Correcta de Course Module ID (cmid)**

**Problema**: Algunos archivos no obten√≠an correctamente el `cmid` del m√≥dulo.

**Soluci√≥n**: Implementado m√©todo est√°ndar:

```php
// M√©todo est√°ndar para obtener cmid
$modinfo = get_fast_modinfo($courseid);
$cmid = null;
foreach ($modinfo->get_cms() as $cm) {
    if ($cm->modname === 'learningstylesurvey') {
        $cmid = $cm->id;
        break;
    }
}
```

**Archivos Verificados**:

- ‚úÖ `uploadresource.php` - Ya usa m√©todo correcto
- ‚úÖ `vista_estudiante.php` - Ya usa m√©todo correcto  
- ‚úÖ `organizar_ruta.php` - Ya usa m√©todo correcto
- ‚úÖ `manage_quiz.php` - Ya usa m√©todo correcto

#### 3. **Navegaci√≥n Est√°ndar entre P√°ginas**

**Problema**: Enlaces que no segu√≠an las convenciones de Moodle para navegaci√≥n.

**Soluci√≥n**: Todos los enlaces ahora usan:

- `moodle_url` para construcci√≥n de URLs
- Par√°metros apropiados (`courseid`, `id`, etc.)
- Rutas absolutas desde la ra√≠z de Moodle

### üîç Archivos con Portabilidad Verificada

#### Archivos Principales ‚úÖ

- `view.php` - Men√∫ principal del m√≥dulo
- `vista_estudiante.php` - Interfaz de estudiante
- `responder_quiz.php` - Sistema de evaluaciones
- `organizar_ruta.php` - Organizador de rutas

#### Archivos de Gesti√≥n ‚úÖ

- `manage_quiz.php` - Gesti√≥n de ex√°menes
- `uploadresource.php` - Subida de recursos
- `crear_examen.php` - Creaci√≥n de ex√°menes
- `verificar_funcionalidades.php` - Herramientas de verificaci√≥n

#### Archivos de Navegaci√≥n ‚úÖ

- `ver_recurso.php` - Visualizaci√≥n de recursos
- Todos los enlaces de retorno funcionan correctamente

### üöÄ Beneficios de la Portabilidad

1. **Instalaci√≥n en Cualquier Entorno**: El m√≥dulo funcionar√° correctamente en diferentes instancias de Moodle
2. **URLs Din√°micas**: No depende de IDs espec√≠ficos del entorno de desarrollo
3. **Compatibilidad con Subdirectorios**: Funciona si Moodle est√° instalado en subdirectorios
4. **Compatibilidad con SSL/HTTPS**: Las URLs se adaptan autom√°ticamente al protocolo
5. **Multi-tenant**: Funciona en entornos con m√∫ltiples sitios Moodle

### üîß M√©todo de Navegaci√≥n Est√°ndar Implementado

```php
// Patr√≥n est√°ndar para navegar de vuelta al m√≥dulo
$modinfo = get_fast_modinfo($courseid);
$cmid = null;
foreach ($modinfo->get_cms() as $cm) {
    if ($cm->modname === 'learningstylesurvey') {
        $cmid = $cm->id;
        break;
    }
}

if ($cmid) {
    $viewurl = new moodle_url('/mod/learningstylesurvey/view.php', ['id' => $cmid]);
    echo html_writer::link($viewurl, 'Regresar al men√∫', ['class' => 'btn btn-secondary']);
} else {
    $courseurl = new moodle_url('/course/view.php', ['id' => $courseid]);
    echo html_writer::link($courseurl, 'Regresar al curso', ['class' => 'btn btn-secondary']);
}
```

### ‚úÖ Estado Final de Portabilidad

- **14 enlaces corregidos** en 7 archivos cr√≠ticos
- **0 errores de sintaxis** detectados
- **Navegaci√≥n est√°ndar** implementada en todos los archivos
- **Portabilidad completa** verificada

El m√≥dulo est√° ahora listo para instalaci√≥n en cualquier entorno Moodle sin dependencias de IDs espec√≠ficos.

---

## 12. Licencia y soporte

Este plugin se distribuye bajo GPL v3.  
Para soporte, mejorar funcionalidades o reportar errores, utiliza el sistema de issues en [GitHub](https://github.com/EderPG/learningstylesurvey).

---

## 13. Recursos √∫tiles

- [Documentaci√≥n oficial de Moodle para desarrolladores](https://moodledev.io/)
- [API Database Moodle](https://moodledev.io/docs/apis/core/dml)
- [Ejemplo de plugin modular](https://moodledev.io/docs/apis/plugins)
- [Gu√≠a de estilos de c√≥digo Moodle](https://moodledev.io/docs/guides/codingstyle)
- [Foro de la comunidad Moodle](https://moodle.org/mod/forum/)

---

## 14. Roadmap y mejoras futuras

- Integraci√≥n con anal√≠ticas de aprendizaje.
- Soporte para nuevos estilos y algoritmos de clasificaci√≥n.
- Expansi√≥n de recursos multimedia y actividades.
- Mejoras en la visualizaci√≥n y reportes docentes.
- Internacionalizaci√≥n completa.
- Pruebas automatizadas y cobertura de c√≥digo.

---

## 15. Cr√©ditos

Desarrollado por **EderPG** y colaboradores.
Agradecimientos a la comunidad Moodle y usuarios que han aportado sugerencias y reportes.

---
